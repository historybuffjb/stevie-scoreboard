<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scoreboard Portal</title>
  <style>
    body { font-family: Arial, sans-serif; background: #222; color: #fff; text-align: center; padding-top: 60px; }
    .container { background: #333; border-radius: 20px; padding: 40px; display: inline-block; }
    label { font-size: 1.2em; margin: 10px; }
    input { font-size: 1.2em; margin: 10px; padding: 5px; border-radius: 5px; border: none; }
    button { font-size: 1.2em; margin: 20px; padding: 10px 30px; border-radius: 10px; border: none; background: #6a5acd; color: #fff; cursor: pointer; }
    button:hover { background: #483d8b; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Scoreboard Portal</h2>
    <form id="portalForm">
      <div>
        <label for="scoreboardDataSelect">Select Full Scoreboard:</label>
        <select id="scoreboardDataSelect">
          <option value="1">Full Scoreboard 1</option>
          <option value="2">Full Scoreboard 2</option>
        </select>
      </div>
      <div>
        <label for="tournament_name">Tournament Name:</label>
        <input type="text" id="tournament_name" name="tournament_name" placeholder="Stevie Chan Memorial 2026" required>
      </div>
      <div>
        <label for="playerA">Player 1 Name:</label>
        <input type="text" id="playerA" name="playerA" required>
      </div>
      <div>
        <label for="playerB">Player 2 Name:</label>
        <input type="text" id="playerB" name="playerB" required>
      </div>
      <div>
        <label for="race">Race to:</label>
        <input type="number" id="race" name="race" min="1" required>
      </div>
      <div>
        <label for="scoreA">Player 1 Score:</label>
        <input type="number" id="scoreA" name="scoreA" min="0" required>
      </div>
      <div>
        <label for="scoreB">Player 2 Score:</label>
        <input type="number" id="scoreB" name="scoreB" min="0" required>
      </div>
      <button type="submit">Update</button>
  <button type="button" id="resetBtn">Reset Scores</button>
  <button type="button" id="resetPositionsBtn">Reset Scoreboard Positions</button>
    </form>
    <hr>
    <h3>Scoreboard Configuration</h3>
    <div id="scoreboard-config">
      <div>
        <label for="scoreboardSelect">Select Scoreboard:</label>
        <select id="scoreboardSelect">
          <option value="scorebar1">Full Scoreboard 1</option>
          <option value="scorebar2">Full Scoreboard 2</option>
          <option value="mini-scorebar1">Mini Scoreboard 1</option>
          <option value="mini-scorebar2">Mini Scoreboard 2</option>
        </select>
      </div>
      <div>
        <label for="visibleSelect">Visibility:</label>
        <select id="visibleSelect">
          <option value="true">Show</option>
          <option value="false">Hide</option>
        </select>
      </div>
      <div>
        <label for="sizeInput">Size (scale):</label>
        <input type="number" id="sizeInput" min="0.1" max="2" step="0.01" value="1">
      </div>
      <div>
        <label for="widthInput">Width (% of viewport):</label>
        <input type="number" id="widthInput" min="10" max="100" step="1" value="90" placeholder="90">
      </div>
      <div>
        <label for="heightInput">Height (vh units):</label>
        <input type="number" id="heightInput" min="1" max="20" step="0.1" value="5.28" placeholder="5.28">
      </div>
      <div>
        <label for="xInput">X Offset (vw):</label>
        <input type="number" id="xInput" min="0" max="100" step="0.1" value="0">
      </div>
      <div>
        <label for="yInput">Y Offset (vh):</label>
        <input type="number" id="yInput" min="0" max="100" step="0.1" value="0">
      </div>
      <button type="button" id="applyConfigBtn">Apply Configuration</button>
    </div>
    <div id="status"></div>
  </div>
    <script src="fonts.js"></script>
    <script>
    async function fetchInitial() {
      const res = await fetch('/api/scoreboard');
      const data = await res.json();
      // Default to scoreboard 1
      const sb = document.getElementById('scoreboardDataSelect').value;
      if (sb === '1') {
        document.getElementById('playerA').value = data.scoreboard.player1;
        document.getElementById('playerB').value = data.scoreboard.player2;
        document.getElementById('scoreA').value = data.scoreboard.score1;
        document.getElementById('scoreB').value = data.scoreboard.score2;
        document.getElementById('race').value = data.scoreboard.race;
      } else {
        document.getElementById('playerA').value = data.scoreboard2.player1;
        document.getElementById('playerB').value = data.scoreboard2.player2;
        document.getElementById('scoreA').value = data.scoreboard2.score1;
        document.getElementById('scoreB').value = data.scoreboard2.score2;
        document.getElementById('race').value = data.scoreboard2.race;
      }
      document.getElementById('tournament_name').value = data.config.tournament_name || 'Stevie Chan Memorial 2026';
      
      // Load current configuration for the selected scoreboard
      loadScoreboardConfig(data.config);
      
      // Store the full config data for use by other functions
      window.currentConfig = data.config;
    }

    function loadScoreboardConfig(config) {
      const id = document.getElementById('scoreboardSelect').value;
      
      // Set default values or load from config
      document.getElementById('sizeInput').value = config[`${id}_scale`] || '1';
      document.getElementById('widthInput').value = config[`${id}_width`] || (id.includes('mini') ? '36' : '90');
      document.getElementById('heightInput').value = config[`${id}_height`] || (id.includes('mini') ? '2.1' : '5.28');
      document.getElementById('xInput').value = config[`${id}_x`] || '0';
      document.getElementById('yInput').value = config[`${id}_y`] || '0';
      
      // Set visibility
      const visible = config[`${id}_visible`] !== '0';
      document.getElementById('visibleSelect').value = visible ? 'true' : 'false';
    }
    window.addEventListener('DOMContentLoaded', () => {
      fetchInitial();
      document.getElementById('scoreboardDataSelect').addEventListener('change', fetchInitial);
      document.getElementById('scoreboardSelect').addEventListener('change', () => {
        // When scoreboard config selection changes, load values from stored config
        if (window.currentConfig) {
          loadScoreboardConfig(window.currentConfig);
        }
      });
    });

    document.getElementById('portalForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const sb = document.getElementById('scoreboardDataSelect').value;
      const playerA = document.getElementById('playerA').value;
      const playerB = document.getElementById('playerB').value;
      const race = document.getElementById('race').value;
      const scoreA = document.getElementById('scoreA').value;
      const scoreB = document.getElementById('scoreB').value;
      const tournament_name = document.getElementById('tournament_name').value;
      let status = '';
      try {
        let body;
        if (sb === '1') {
          body = {
            scoreboard: {
              player1: playerA,
              player2: playerB,
              race,
              score1: Number(scoreA),
              score2: Number(scoreB)
            },
            config: { tournament_name }
          };
        } else {
          body = {
            scoreboard2: {
              player1: playerA,
              player2: playerB,
              race,
              score1: Number(scoreA),
              score2: Number(scoreB)
            },
            config: { tournament_name }
          };
        }
        await fetch('/api/scoreboard', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        status = 'Updated successfully!';
        await fetchInitial();
      } catch {
        status = 'Error updating!';
      }
      document.getElementById('status').textContent = status;
    });

    document.getElementById('resetBtn').addEventListener('click', async function() {
      try {
        await fetch('/api/scoreboard', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            scoreboard: { score1: 0, score2: 0 },
            scoreboard2: { score1: 0, score2: 0 }
          })
        });
        document.getElementById('scoreA').value = 0;
        document.getElementById('scoreB').value = 0;
        document.getElementById('status').textContent = 'Scores reset!';
      } catch {
        document.getElementById('status').textContent = 'Error resetting scores!';
      }
    });

    document.getElementById('resetPositionsBtn').addEventListener('click', async function() {
      let status = '';
      try {
        await fetch('/api/scoreboard/reset-positions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        status = 'Scoreboard positions reset!';
        await fetchInitial(); // Refresh all data including config
      } catch {
        status = 'Error resetting positions!';
      }
      document.getElementById('status').textContent = status;
    });

    // Apply Configuration logic
    document.getElementById('applyConfigBtn').addEventListener('click', async function() {
      const id = document.getElementById('scoreboardSelect').value;
      const visible = document.getElementById('visibleSelect').value === 'true';
      const scale = parseFloat(document.getElementById('sizeInput').value);
      const width = parseFloat(document.getElementById('widthInput').value);
      const height = parseFloat(document.getElementById('heightInput').value);
      const x = parseFloat(document.getElementById('xInput').value);
      const y = parseFloat(document.getElementById('yInput').value);
      let status = '';
      try {
        // Visibility
        await fetch('/api/scoreboard/visibility', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, visible })
        });
        // Size, dimensions, and position
        await fetch('/api/scoreboard', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            config: {
              [`${id}_scale`]: scale,
              [`${id}_width`]: width,
              [`${id}_height`]: height,
              [`${id}_x`]: x,
              [`${id}_y`]: y
            }
          })
        });
        status = 'Configuration applied!';
        
        // Refresh the config data to keep it in sync
        await fetchConfigData();
      } catch {
        status = 'Error applying configuration!';
      }
      document.getElementById('status').textContent = status;
    });

    // Helper function to refresh just the config data
    async function fetchConfigData() {
      try {
        const res = await fetch('/api/scoreboard');
        const data = await res.json();
        window.currentConfig = data.config;
      } catch (error) {
        console.error('Error fetching config data:', error);
      }
    }
  </script>
</body>
</html>
